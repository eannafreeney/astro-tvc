---
import { getProductByID } from "../../utils/shopify";
import { getBookBySKU } from "../../api/api";
import { books } from "../../constants/ids";
import Layout from "../../layouts/Layout.astro";
import {
  ImageContainer,
  TextContainer,
  Breadcrumb,
} from "../../components/Product";

export async function getStaticPaths() {
  return Object.keys(books).map((slug) => {
    return {
      params: { handle: slug },
    };
  });
}

const { handle } = Astro.params;
const info = books[handle];

if (!info) {
  const error = await fetch(`${Astro.url}/404`);
  return new Response(error.body, {
    headers: error.headers,
    status: 404,
    statusText: "Not Found",
  });
}

const { ID, SKU } = info;

const headers = Astro.request.headers;
const ip = headers.get("x-vercel-forwarded-for") || Astro.clientAddress;

const [shopifyProduct, airtableData] = await Promise.all([
  getProductByID({
    id: `gid://shopify/Product/${ID}` || "",
    buyerIP: ip,
  }),
  getBookBySKU(SKU),
]);

export const prerender = false;
---

<Layout>
  <section class="md:grid md:grid-cols-[3fr,2fr] md:gap-4">
    <div>
      <div class="container py-4 sm:hidden">
        <Breadcrumb data={airtableData} />
      </div>
      <ImageContainer data={airtableData} />
    </div>
    <div>
      <TextContainer
        airtableData={airtableData}
        shopifyProduct={shopifyProduct}
      />
    </div>
  </section>
</Layout>
